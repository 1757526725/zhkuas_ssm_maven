function showTimeLeft(){var e=new Date,t=beginTime-e;if(t<0)$(".time").html("已经开始"),timerinterval!=null&&clearInterval(timerinterval);else{var n=parseInt(t/1e3/60/60/24,10),r=parseInt(t/1e3/60/60%24,10),i=parseInt(t/1e3/60%60,10),s=parseInt(t/1e3%60,10);n=checkTime(n),r=checkTime(r),i=checkTime(i),s=checkTime(s),$(".time").html(n+"天"+r+"时"+i+"分"+s+"秒")}}function checkTime(e){return e<10&&(e="0"+e),e}function openWin(theID){var theURL,w,h,Tform;w=450,h=380,eval("Tform='width="+w+",height="+h+"'"),theURL="http://jw.zhku.edu.cn/jwmis/JXZY/INFO_Teacher.aspx?id="+theID.getAttribute("value"),pop=window.open(theURL,"winKPT",Tform)}function selradio(theID,N){var object_id,object_value,object_temp,skbz_id,divColl;object_value=theID.value,object_temp=object_value.split("|"),skbz_id=object_temp[0];try{var divCol=document.getElementsByTagName("input");for(i=0;i<divCol.length;i++)divCol[i].type=="radio"&&(divCol[i].checked=!1);if(object_temp[0]!=""){try{eval("window.document.all.J"+object_temp[0]+".checked=true;")}catch(e){}try{eval("window.document.all.S"+object_temp[0]+".checked=true;")}catch(e){}try{eval("window.document.all.E"+object_temp[0]+".checked=true;")}catch(e){}try{eval("window.document.all.D"+object_temp[0]+".checked=true;")}catch(e){}try{eval("window.document.all.M"+object_temp[0]+".checked=true;")}catch(e){}try{eval("window.document.all.N"+object_temp[0]+".checked=true;")}catch(e){}try{eval("window.document.all.P"+object_temp[0]+".checked=true;")}catch(e){}try{eval("window.document.all.Q"+object_temp[0]+".checked=true;")}catch(e){}}else theID.checked=!0}catch(e){}$("[name=jsskbj_str]").val(object_temp[2]),$("#bt-scheme-ensure").button("reset")}function deleteScheme(e){var t=$(e).parent().parent();confirm("你确定要移除这门课程吗?")&&$.ajax({type:"GET",url:"../action/deleteScheme",data:{msid:t.attr("msid")},error:function(e){showAlert("消息","服务器出错，请联系管理员");return},success:function(e){if(e==""){showAlert("消息","删除失败！请重试");return}e=="remove success"&&location.reload()}})}function editScheme(e){var t=$(e).parent().parent();showChooseCourseTimeDialog(t.attr("cNo"))}function moveUp(e){var t=$(e).parent().parent(),n=t.prev();if(n.size()==0)return;var r=t.children(".order_num"),i=n.children(".order_num"),s=r.html();r.html(i.html()),i.html(s),t.addClass("scheme-seleted"),t.parent().children().removeClass("scheme-seleted"),t.addClass("scheme-seleted");var o=t.clone();t.remove(),n.before(o);var u=$("#bt-saveAll");u.removeClass("btn-success"),u.addClass("btn-danger"),u.removeAttr("disabled")}function quickAddToMyscheme(e){if(isLogin==0){showAlert("消息","请登录后操作！");return}if(!isBindStudent||!isBindCompus){showAlert("提示",'<p>1.你可能未绑定教务网账户 <a href="passport?tab=basic">去绑定</a></p><p>2.你可能未绑定上课的校区。 <a href="passport?tab=basic">去绑定校区</a></p>');return}showChooseCourseTimeDialog(e)}function scanConflict(){$(".scan-result").remove(),$(".flag-label").remove();var resultPanel='<div class="panel panel-primary ctrl-panel clearfix scan-result">';resultPanel+='<span class="text-danger">检测结果:</span><span class="initialText">正在检测...</span><div class="loading pull-right"></div><div class="summaryNode"></div>',resultPanel+="</div>";var button=$("#bt-scan-conflict");button.button("loading"),$("#mySchemeForm").after(resultPanel);var summaryNode=$(".summaryNode");summaryNode.empty(),$.ajax({type:"get",url:"../action/scanConflict",async:!0,success:function(data){if(data=="login time out"){showAlert("消息","登录超时，请重新登录！"),button.button("reset"),$(".scan-result").hide();return}if(data==""){var result='<span class="text-danger">服务器错误，检测未完成</span>';dg_addErrorMassage(result,summaryNode),button.button("reset"),$(".scan-result").hide();return}if(data=="no course conflict"){var result='<span class="text-success">没有冲突课程</span>';dg_addErrorMassage(result,summaryNode),button.button("reset"),hideScanResultLoading();return}if(data=="unBind"){var result='<h4 class="text-info">你未确认你的个人课表.无法进行冲突性检测 。<a href="mySchedule" class="text-danger pull-right">点击去确认</a></h4>';dg_addErrorMassage(result,summaryNode),button.button("reset"),hideScanResultLoading();return}var obj=eval("("+data+")");for(index_cNo in obj){if(index_cNo=="end")break;var message='<span class="label label-danger pull-right flag-label">冲突</span>',courseNodeTd=$($("[cNo='"+index_cNo+"']").children().get(1));courseNodeTd.append(message);var result='<span class="text-danger">'+courseNodeTd.children("a").html()+"</span> 与"+'<span class="text-info">'+obj[index_cNo]+"</span>冲突";dg_addErrorMassage(result,summaryNode)}button.button("reset"),hideScanResultLoading()},error:function(e){dg_addErrorMassage("服务器出错，请联系管理员",summaryNode),button.button("reset");return}})}function hideScanResultLoading(){var e=$(".scan-result");e.find(".initialText").hide(),e.find(".loading").hide()}function showChooseCourseTimeDialog(e){$("#initMsgPanel").show(),$("#noticePanel").hide(),$("#optionList").empty(),$("#CourseChoose-dialog").modal("show"),$("#bt-scheme-ensure").attr("disabled","disabled"),$("#bt-scheme-ensure").attr("action-data-cNo",e),getOptionData(e)}function getOptionData(e){var t=$('<h4 class="text-center text-danger" > 没有选课信息，可能是教务网没有该选课信息，也可能是网络错误.<a href="javascript:void(0)" onclick="getOptionData('+e+')">点击刷新！</a></h4>'),n=$('<h4 class="text-center text-danger" > 你打开的不是这学期的课程,是否切换到当前学期课程.<a href="../main/public_course?termNo='+currentTermNo+'">点击切换！</a></h4>');if($(".panel-heading").size()>0&&$(".panel-heading").find("span").html()!=currentTermName){$("#optionList").empty(),$("#optionList").append(n),$("#initMsgPanel").hide();return}$("#initMsgPanel").show(),$.get("../action/courseOption?time="+(new Date).getTime(),{cNo:e},function(e){if(e=="state:nothing"){$("#optionList").empty(),$("#optionList").append(t),$("#initMsgPanel").hide();return}if(e.indexOf("Request process time exceed th max limit")>=0){$("#optionList").empty(),$("#optionList").append(t),$("#initMsgPanel").hide();return}var n=$(e);initOptionData(n);try{$("#optionList").append(n)}catch(r){}var i="",s=n.find("#initActionData");if(s)try{var o=n.find("input");for(var u=0;u<o.length;u++)if(o[u].type=="radio"){i=o[u].value.split("|")[2].split("@")[1];if(s.attr("hadChoose")==i){selradio(o[u],1);return}}}catch(r){console.log(r)}})}function initOptionData(e){$("#initMsgPanel").hide(),$("#noticePanel").show(),e.children("#dataListDiv").children("table").find("table").addClass("table table-bordered")}function loginTest(e,t){t.button("loading"),showLoading("正在为您测试登录教务网..."),$.ajax({type:"POST",contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:"../action/loginSystem",data:{password:e},error:function(e){addActionResult("服务器出错，请重试！"),t.button("reset"),hideLoading();return},success:function(e){if(e=="login out time"){addActionResult("登录超时，请刷新页面，并用微博登录！"),t.button("reset"),hideLoading();return}if(e=="passwordIncorrect"){addActionResult("密码错误"),t.button("reset"),hideLoading();return}if(e=="connect Error"){addActionResult("教务网登录超时，请重试!"),t.button("reset"),hideLoading();return}if(e==""){addActionResult("参数错误，请重试！"),t.button("reset"),hideLoading();return}if(e=="login success"){addActionResult("测试通过","text-success"),t.button("reset"),hideLoading();return}addActionResult("未知错误，请刷新重试！"),t.button("reset"),hideLoading()}})}function addActionResult(e,t,n){var r=$(".result_text");r.empty(),t==null&&(t="text-danger");if(n!=null){r.append('<h3 style="font-size:'+n+"px;\"class='"+t+"'>"+e+"</h3>");return}r.append("<h3 class='"+t+"'>"+e+"</h3>")}function showLoading(e){$(".result_loading").children("span").html(e),$(".result_loading").show()}function hideLoading(){$(".result_loading").hide()}function oneKeyBegin(e,t){$(".bt_begin").button("reset"),$(".submit-items").empty();var n=0,r=$("tbody").find("tr"),e=$("#systemPassword").val();if(t=="true")for(var n=0;n<r.size();++n){var i=$(r.get(n)),s=i.attr("formvalue"),o=i.attr("cno"),u=$(i.children()[4]).html(),a=$(i.children()[2]).html(),f=$(i.children()[1]).children("a").html(),l='<p id="item_'+o+'"><span class="text-info">'+f+' </span><span><img src="../images/loading_min.gif"></span><span class="text-danger message"> 提交中...</span></p>';$(".submit-items").append(l),submitOnKeyCourse(e,o,u,f,s,a)}else startInterval=setInterval(function(){if(n>=r.size()&&startInterval!=null){clearInterval(startInterval);return}var t=$(r.get(n)),i=t.attr("formvalue"),s=t.attr("cno"),o=$(t.children()[4]).html(),u=$(t.children()[2]).html(),a=$(t.children()[1]).children("a").html(),f='<p id="item_'+s+'"><span class="text-info">'+a+' </span><span><img src="../images/loading_min.gif"></span><span class="text-danger message"> 提交中...</span></p>';$(".submit-items").append(f),n++,submitOnKeyCourse(e,s,o,a,i,u)},2e3)}function submitOnKeyCourse(e,t,n,r,i,s){var o=$(".bt_begin"),u=' <a class="text-info" href="javascript:void(0)" onclick="submitOnKeyCourse(\''+e+"','"+t+"','"+n+"','"+r+"','"+i+"','"+s+"')\">重新提交</a>";$("#item_"+t).find(".message").html("提交中..."),$.ajax({type:"POST",contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:"../action/submitOneKeyCourse",data:{password:e,cNo:t,tName:n,courseName:r,formValue:i,credit:s},error:function(e){addActionResult("服务器出错，请重试！"+u),o.button("reset");return},success:function(e){if(e.indexOf("Request process time exceed th max limit")>=0){$("#item_"+t).find(".message").html("提交请求超时..."+u);return}if(e=="获取不到选课结果"){$("#item_"+t).find(".message").html("获取不到选课结果..."+u);return}$("#item_"+t).find(".message").html(e+u)}})}var timerinterval=null,startInterval=null,beginTime=new Date("12/18/2013 10:30");studentGrade&&studentGrade==2012&&(beginTime=new Date("12/20/2013 10:30")),studentGrade&&studentGrade==2013&&(beginTime=new Date("12/23/2013 10:30")),$(function(){$("#bt-scheme-ensure").click(function(){var e=$("#bt-scheme-ensure").attr("action-data-cNo");$("#cNo").size()>0?addMyScheme(e,function(){$("#bt-addToMyPlan").attr("disabled","disabled"),$("#bt-addToMyPlan").html('<span class="glyphicon glyphicon-plus"></span> 已加入选课方案')}):addMyScheme(e,function(){location.reload()})}),$("#bt-scan-conflict").click(function(){scanConflict()}),$("#bt-saveAll").click(function(){var e=$("#bt-saveAll");e.button("loading"),$.ajax({type:"POST",contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:"../action/saveScheme",data:$("#mySchemeForm").serialize(),error:function(t){showAlert("消息","服务器出错，请联系管理员"),e.button("reset");return},success:function(t){if(t==""){showAlert("消息","提交失败，请重试！"),e.button("reset");return}if(t=="save success"){showAlert("消息","保存成功",function(){location.reload()});return}}})}),$("#bt-deleteAll").click(function(){if(!confirm("你确定要清空所有课程吗?"))return;var e=$("#bt-deleteAll");e.button("loading"),$.ajax({type:"get",url:"../action/clearScheme",error:function(t){showAlert("消息","服务器出错，请联系管理员"),e.button("reset");return},success:function(t){if(t==""){showAlert("消息","清空失败，请重试！"),e.button("reset");return}if(t=="clear success"){location.reload();return}if(t=="login out time"){showAlert("消息","登录超时,请重新登录！");return}}})}),$("#bt-addMore").click(function(){if(!isBindStudent||!isBindCompus){showAlert("提示",'<p>1.你可能未绑定教务网账户 <a href="passport?tab=basic">去绑定</a></p><p>2.你可能未绑定上课的校区。 <a href="passport?tab=basic">去绑定校区</a></p>');return}location.href="../main/public_course?compusId="+compusId}),$("#bt-oneKey").click(function(){$(".onekey").show(),$(".scan-result").hide(),timerinterval=setInterval("showTimeLeft()",1e3),$("#systemPassword").val("")}),$(".bt_login_test").click(function(){if($("#systemPassword").val()==""){addActionResult("密码不能为空");return}loginTest($("#systemPassword").val(),$(".bt_login_test"))}),$(".bt_begin").click(function(){if($("#systemPassword").val()==""){addActionResult("密码不能为空");return}var e=$("#systemPassword").val(),t=$(".maxCredit").val(),n=$(".submitWay").val();$(".bt_begin").button("loading"),addActionResult("已经启动，时间到了，自动选课，请不要刷新","text-success","14"),myinterval=setInterval(function(){var t=new Date,r=beginTime-t;r<0&&(oneKeyBegin(e,n),myinterval!=null&&clearInterval(myinterval))},1e3)}),$(".bt_go_now").click(function(){if($("#systemPassword").val()==""){addActionResult("亲!你密码都没填！");return}showMyConfirm("你确定系统提前了？点击确定选课助手会将你的提交时间提前为当前时间。",function(){beginTime=new Date,addActionResult("已经修改为当前时间,赶快点击 启动吧！")})})})